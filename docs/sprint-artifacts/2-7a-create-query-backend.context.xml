<story-context id="2-7a-create-query-backend" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7a</storyId>
    <title>Create Query Backend</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-7a-create-query-backend.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user exploring events</asA>
    <iWant>to save my current search/filters as a named query</iWant>
    <soThat>I can persist useful patterns and revisit them from the sidebar</soThat>
    <tasks>
      <task id="1" ac="2.7a.1">Create Queries Router File
        <subtask>1.1 Create src/server/api/routers/queries.ts router file</subtask>
        <subtask>1.2 Import createTRPCRouter, protectedProcedure from trpc.ts</subtask>
        <subtask>1.3 Import z from 'zod' for input validation</subtask>
        <subtask>1.4 Import TRPCError for error handling</subtask>
      </task>
      <task id="2" ac="2.7a.2">Define Query Filters Schema
        <subtask>2.1 Create or update src/lib/filters/types.ts with QueryFiltersSchema</subtask>
        <subtask>2.2 Schema structure: { keywords: z.array(z.string().min(1).max(100)).min(1) } (multi-keyword to match SearchContext)</subtask>
        <subtask>2.3 Export QueryFilters type for use across the application</subtask>
      </task>
      <task id="3" ac="2.7a.1,2.7a.3,2.7a.4">Implement queries.create Mutation
        <subtask>3.1 Define input schema: { name: z.string().min(1).max(100), filters: QueryFiltersSchema }</subtask>
        <subtask>3.2 Use protectedProcedure to ensure user is authenticated</subtask>
        <subtask>3.3 Create UserQuery record with userId from ctx.session.user.id</subtask>
        <subtask>3.4 Store filters as JSON in the filters column</subtask>
        <subtask>3.5 Return created query object including id, name, filters, createdAt</subtask>
      </task>
      <task id="4" ac="2.7a.1">Register Queries Router
        <subtask>4.1 Import queriesRouter in src/server/api/root.ts</subtask>
        <subtask>4.2 Add queries router to appRouter</subtask>
      </task>
      <task id="5" ac="2.7a.1">Implement queries.list Query (enabler for Story 2.8)
        <subtask>5.1 Create queries.list procedure to fetch user's saved queries</subtask>
        <subtask>5.2 Filter by userId from session</subtask>
        <subtask>5.3 Order by createdAt DESC</subtask>
        <subtask>5.4 Return array of UserQuery objects</subtask>
      </task>
      <task id="6" ac="All">Testing and Validation
        <subtask>6.1 Run build, lint, typecheck to ensure no errors</subtask>
        <subtask>6.2 Manually test mutation via tRPC playground or client call</subtask>
        <subtask>6.3 Verify query is saved to database with correct userId</subtask>
        <subtask>6.4 Verify returned object contains id, name, filters</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="2.7a.1">queries.create mutation saves query to database</criterion>
    <criterion id="2.7a.2">Input validated with Zod schema (name: 1-100 chars, filters: QueryFiltersSchema)</criterion>
    <criterion id="2.7a.3">Query associated with current user's ID (userId from session)</criterion>
    <criterion id="2.7a.4">Returns created query with ID</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Tech Spec" section="Story 2.7a" snippet="Defines queries.create mutation with QueryFiltersSchema input, protectedProcedure for auth, and Prisma UserQuery.create" />
      <doc path="docs/epics/epic-2-user-controlled-queries-with-keyboard-foundation-story-breakdown.md" title="Epic 2 Story Breakdown" section="Story 2.7a" snippet="Create Query Backend - tRPC mutations to create saved queries with user isolation and Zod validation" />
      <doc path="docs/sprint-artifacts/2-6-filter-ui-logic.md" title="Previous Story 2.6" section="Dev Agent Record" snippet="SearchContext uses keywords: string[] array. Multi-keyword AND search implemented. Tag-pill UI pattern." />
      <doc path="docs/architecture.md" title="Architecture" section="API Response Formats, Error Handling" snippet="tRPC patterns, TRPCError codes for UNAUTHORIZED/FORBIDDEN/BAD_REQUEST" />
    </docs>
    <code>
      <file path="src/server/api/routers/events.ts" kind="router" symbol="eventsRouter" reason="Reference pattern for tRPC router structure, protectedProcedure usage, Zod input validation">
        <interface name="events.search input" signature="z.object({ keywords: z.array(z.string().max(100)).min(1).max(10), limit: z.number().min(1).max(100).default(50) })" />
      </file>
      <file path="src/server/api/root.ts" kind="router-registry" symbol="appRouter" lines="1-27" reason="MODIFY: Add queriesRouter import and registration alongside eventsRouter">
        <interface name="appRouter" signature="createTRPCRouter({ gitlab, projects, events, queries? })" />
      </file>
      <file path="src/server/api/trpc.ts" kind="trpc-setup" symbol="protectedProcedure" lines="162-174" reason="protectedProcedure enforces ctx.session.user, provides db access via ctx.db">
        <interface name="protectedProcedure context" signature="{ session: { user: { id: string } }, db: PrismaClient }" />
      </file>
      <file path="prisma/schema.prisma" kind="schema" symbol="UserQuery" lines="94-105" reason="UserQuery model with id, userId, name, filters (Json), lastViewedAt, timestamps">
        <interface name="UserQuery model" signature="model UserQuery { id: cuid, userId: string, name: string, filters: Json, lastViewedAt?: DateTime, createdAt, updatedAt }" />
      </file>
      <file path="src/components/search/SearchContext.tsx" kind="context" symbol="SearchContextValue" lines="25-42" reason="Frontend keywords: string[] interface - QueryFiltersSchema must match this format">
        <interface name="keywords state" signature="keywords: string[]" />
      </file>
    </code>
    <dependencies>
      <node>
        <package name="@prisma/client" version="^6.6.0" />
        <package name="@trpc/server" version="^11.0.0" />
        <package name="zod" version="^3.24.2" />
        <package name="superjson" version="^2.2.1" />
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="queries.create" kind="tRPC mutation">
      <signature>
protectedProcedure
  .input(z.object({
    name: z.string().min(1).max(100),
    filters: z.object({
      keywords: z.array(z.string().min(1).max(100)).min(1),
    }),
  }))
  .mutation(async ({ ctx, input }) => UserQuery)
      </signature>
      <path>src/server/api/routers/queries.ts</path>
    </interface>
    <interface name="queries.list" kind="tRPC query">
      <signature>
protectedProcedure.query(async ({ ctx }) => UserQuery[])
      </signature>
      <path>src/server/api/routers/queries.ts</path>
    </interface>
    <interface name="QueryFiltersSchema" kind="Zod schema">
      <signature>
z.object({
  keywords: z.array(z.string().min(1).max(100)).min(1),
})
      </signature>
      <path>src/lib/filters/types.ts</path>
      <note>TECH SPEC DEVIATION: Uses keywords: string[] instead of keyword: string to match SearchContext from Story 2.6</note>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="security">User Isolation: All queries MUST filter by ctx.session.user.id - never expose other users' queries</constraint>
    <constraint type="security">Authorization: Use protectedProcedure to ensure user is authenticated before any database operation</constraint>
    <constraint type="validation">Input Validation: Zod schema validates all inputs before Prisma operations - name 1-100 chars, keywords array min 1</constraint>
    <constraint type="pattern">Router Pattern: Follow events.ts pattern - import from trpc.ts, export named router, add to root.ts appRouter</constraint>
    <constraint type="pattern">Error Handling: Use TRPCError with appropriate codes (UNAUTHORIZED, BAD_REQUEST) - see events.ts for examples</constraint>
    <constraint type="data">JSON Storage: filters column stores QueryFilters as JSON - Prisma handles serialization automatically</constraint>
    <constraint type="deviation">Tech Spec Deviation: Use keywords: string[] to match frontend (Story 2.6) instead of keyword: string from original spec</constraint>
  </constraints>

  <tests>
    <standards>MVP approach: No unit tests required per ADR-006. Validation via build/lint/typecheck and manual testing. Unit tests only when debugging same bug twice.</standards>
    <locations>
      <location>Manual testing via tRPC playground or client component</location>
      <location>Build validation: npm run build, npm run lint, npm run typecheck</location>
    </locations>
    <ideas>
      <idea ac="2.7a.1">Manual: Call queries.create mutation, verify record appears in database</idea>
      <idea ac="2.7a.2">Manual: Test with empty name (should fail), name >100 chars (should fail), empty keywords (should fail)</idea>
      <idea ac="2.7a.3">Manual: Create query, check UserQuery.userId matches session user ID</idea>
      <idea ac="2.7a.4">Manual: Verify response includes id, name, filters, createdAt fields</idea>
    </ideas>
  </tests>
</story-context>
